<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Caja - Modelorama</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { height: 100vh; overflow: hidden; background: #e9ecef; }
        .main-container { height: calc(100vh - 60px); }
        .products-area { overflow-y: auto; height: 100%; padding: 20px; }
        .product-card { cursor: pointer; transition: 0.2s; border: none; background: white; border-radius: 10px; height: 100%; overflow: hidden; }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(13,110,253,0.2); border: 1px solid #0d6efd; }
        .cart-area { background: white; height: 100%; display: flex; flex-direction: column; border-left: 1px solid #dee2e6; }
        .cart-list { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* Modales */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
        /* AQUI ESTÁ EL ARREGLO DEL FONDO BLANCO: */
        .modal-custom { background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark px-3 h-60px">
    <a class="navbar-brand" href="#"><i class="bi bi-shop"></i> Caja</a>
    <div class="d-flex align-items-center gap-3">
        <button class="btn btn-warning position-relative" onclick="abrirPedidos()">
            <i class="bi bi-bell-fill"></i>
            <span id="badgeP" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
        </button>
        
        <span id="stCaja" class="badge bg-secondary">...</span>
        <button id="btnCorte" onclick="caja()" class="btn btn-outline-light btn-sm">Caja</button>
        <a href="/dashboard.html" class="btn btn-primary btn-sm" id="btnDash">Inventario</a>
        <button onclick="logout()" class="btn btn-danger btn-sm"><i class="bi bi-power"></i></button>
    </div>
</nav>

<div class="row g-0 main-container">
    <div class="col-md-8 products-area">
        <div class="d-flex gap-2 mb-3 overflow-auto pb-2">
             <button class="btn btn-warning btn-sm fw-bold" onclick="addEnv('ENV-001')">Imp. Mega</button>
             <button class="btn btn-warning btn-sm fw-bold" onclick="addEnv('ENV-002')">Imp. Media</button>
             <button class="btn btn-info btn-sm fw-bold text-white" onclick="addEnv('EXT-001')">Imp. cuartito</button>
        </div>
        <div class="input-group mb-4 shadow-sm">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input type="text" id="buscador" class="form-control border-start-0" placeholder="Buscar..." onkeyup="filtrar()">
        </div>
        <div id="grid" class="row g-3"></div>
    </div>

    <div class="col-md-4 cart-area">
        <div class="p-3 bg-light border-bottom"><h5><i class="bi bi-receipt"></i> Ticket</h5></div>
        <div id="cart" class="cart-list"></div>
        <div class="p-3 bg-light border-top">
            <div class="d-flex justify-content-between mb-2">
                <span class="fs-5">Total:</span><span class="fs-4 fw-bold text-success">$<span id="total">0.00</span></span>
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-success btn-lg" onclick="cobrar()">COBRAR </button>
                <button class="btn btn-outline-danger" onclick="limpiar()">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div id="modalPedidos" class="modal-overlay">
    <div class="modal-custom">
        <h4>Pedidos Web Pendientes</h4>
        <p class="text-muted small">Clientes esperando entrega</p>
        <div id="listaP" class="my-3 overflow-auto border rounded p-2 bg-light" style="max-height:300px"></div>
        <div class="text-end"><button class="btn btn-secondary" onclick="document.getElementById('modalPedidos').style.display='none'">Cerrar</button></div>
    </div>
</div>

<div id="modalTicket" class="modal-overlay">
    <div class="modal-custom text-center" style="width:350px">
        <h4>MODELORAMA</h4>
        <p class="text-muted">Ticket #<span id="tid"></span></p>
        <div id="titems" class="text-start border-top border-bottom py-2 my-2"></div>
        <h3 class="text-end">$<span id="ttotal"></span></h3>
        <button class="btn btn-primary mt-3" onclick="document.getElementById('modalTicket').style.display='none'">Cerrar</button>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    const u = JSON.parse(localStorage.getItem('usuario') || '{}');

    // Validación
    if(!token) location.href='/index.html';
    if(u.rol !== 'admin') document.getElementById('btnDash').style.display='none';

    let inv = [], cart = [], open = false;

    // Iniciar
    init();

    async function init() {
        const res = await fetch('/api/productos', {headers:{'Authorization':'Bearer '+token}});
        inv = await res.json();
        render(inv);
        checkCaja();
        // Polling Pedidos (Cada 5 seg)
        setInterval(checkPedidos, 5000); 
        checkPedidos();
    }

    function render(l) {
        document.getElementById('grid').innerHTML = l.map(p => {
            if(p.stock_actual <= 0) return '';
            const img = p.imagen ? `/uploads/${p.imagen}` : 'https://via.placeholder.com/150?text=Sin+Foto';
            return `
            <div class="col-6 col-md-4 col-lg-3">
                <div class="product-card p-0 text-center" onclick="add(${p.id})">
                    <div style="height:120px;overflow:hidden">
                        <img src="${img}" class="w-100 h-100 object-fit-cover">
                    </div>
                    <div class="p-2">
                        <div class="fw-bold text-truncate small" title="${p.nombre}">${p.nombre}</div>
                        <div class="badge bg-primary">$${p.precio_venta}</div>
                        <div class="small text-muted" style="font-size:0.75rem">Stock: ${p.stock_actual}</div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function filtrar() { 
        const t = document.getElementById('buscador').value.toLowerCase(); 
        render(inv.filter(p => p.nombre.toLowerCase().includes(t))); 
    }
    
    // CARRITO
    function add(id) {
        if(!open) return alert("¡Abre caja primero!");
        const p = inv.find(x => x.id === id);
        const ex = cart.find(x => x.id === id);
        
        if(ex) { 
            if(ex.q < p.stock_actual) ex.q++; 
            else return alert("Stock insuficiente"); 
        } else {
            cart.push({id:p.id, n:p.nombre, p:parseFloat(p.precio_venta), q:1, max:p.stock_actual});
        }
        drawCart();
    }
    
    function addEnv(c) { 
        const p = inv.find(x => x.codigo_barras === c); 
        if(p) add(p.id); 
        else alert("Producto no encontrado (Ejecuta SQL envases)");
    }

    function drawCart() {
        let t = 0;
        const html = cart.map((i,x) => { 
            t += i.p * i.q; 
            return `
            <div class="d-flex justify-content-between border-bottom py-2 align-items-center">
                <div>${i.n}<br><small class="text-muted">$${i.p}</small></div>
                <div>
                    <button class="btn btn-sm btn-light border" onclick="mod(${x},-1)">-</button> 
                    <span class="mx-1">${i.q}</span> 
                    <button class="btn btn-sm btn-light border" onclick="mod(${x},1)">+</button>
                </div>
            </div>`; 
        }).join('');
        
        document.getElementById('cart').innerHTML = html || '<div class="text-center mt-5 text-muted">Carrito Vacío</div>';
        document.getElementById('total').textContent = t.toFixed(2);
    }

    function mod(i,d) { 
        cart[i].q += d; 
        if(cart[i].q <= 0) cart.splice(i,1); 
        else if(cart[i].q > cart[i].max) cart[i].q = cart[i].max; 
        drawCart(); 
    }
    function limpiar() { cart=[]; drawCart(); }

    async function cobrar() {
        const tot = parseFloat(document.getElementById('total').textContent);
        if(!cart.length || !confirm("¿Cobrar $"+tot+"?")) return;
        
        try {
            const res = await fetch('/api/ventas', {
                method:'POST', 
                headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, 
                body:JSON.stringify({carrito:cart.map(x=>({id:x.id, cantidad:x.q, precio:x.p})), total:tot})
            });
            
            if(res.ok) {
                const d = await res.json();
                // Mostrar Ticket
                document.getElementById('tid').textContent = d.ticketId; 
                document.getElementById('ttotal').textContent = tot.toFixed(2); 
                document.getElementById('titems').innerHTML = cart.map(x=>`<div>${x.q} x ${x.n} - $${(x.p*x.q).toFixed(2)}</div>`).join('');
                document.getElementById('modalTicket').style.display = 'flex';
                
                limpiar(); 
                // Recargar inventario para actualizar stock visual
                const resInv = await fetch('/api/productos', {headers:{'Authorization':'Bearer '+token}});
                inv = await resInv.json();
                render(inv);
            }
        } catch(e) { alert("Error de conexión"); }
    }

    // CONTROL DE CAJA
    async function checkCaja() {
        const res = await fetch('/api/caja/estado', {headers:{'Authorization':'Bearer '+token}});
        const d = await res.json();
        open = d.abierto;
        document.getElementById('stCaja').textContent = open ? "Abierta" : "Cerrada";
        document.getElementById('stCaja').className = open ? "badge bg-success" : "badge bg-danger";
        document.getElementById('btnCorte').textContent = open ? "Cerrar Turno" : "Abrir Turno";
    }

    async function caja() {
        if(open) {
            const m = prompt("Cierre de turno. Ingresa efectivo total:"); 
            if(!m) return;
            const res = await fetch('/api/caja/cerrar', {
                method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, 
                body:JSON.stringify({monto_final:m})
            });
            if(res.ok) { 
                const d = await res.json(); 
                alert(`Corte realizado.\nDiferencia: $${d.resumen.diferencia}`); 
                location.reload(); 
            }
        } else {
            const m = prompt("Apertura de turno. Fondo inicial:"); 
            if(!m) return;
            const res = await fetch('/api/caja/abrir', {
                method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, 
                body:JSON.stringify({monto_inicial:m})
            });
            if(res.ok) location.reload();
        }
    }

    // PEDIDOS WEB (POLLING)
    async function checkPedidos() {
        try {
            const res = await fetch('/api/pedidos/pendientes', {headers:{'Authorization':'Bearer '+token}});
            const l = await res.json();
            const badge = document.getElementById('badgeP');
            badge.textContent = l.length;
            if(l.length > 0) badge.classList.remove('d-none'); else badge.classList.add('d-none');
            return l;
        } catch(e) { return []; }
    }

    async function abrirPedidos() {
        document.getElementById('modalPedidos').style.display='flex';
        const l = await checkPedidos();
        const div = document.getElementById('listaP');
        
        if(l.length === 0) {
            div.innerHTML = '<div class="text-center text-muted">No hay pedidos pendientes.</div>';
            return;
        }

        div.innerHTML = l.map(p => `
            <div class="border p-2 mb-2 rounded bg-white shadow-sm">
                <div class="d-flex justify-content-between">
                    <strong>${p.cliente}</strong>
                    <span class="text-success fw-bold">$${p.total}</span>
                </div>
                <div class="small text-muted">${new Date(p.fecha).toLocaleTimeString()}</div>
                <button class="btn btn-sm btn-primary w-100 mt-2" onclick="entregar(${p.id})">✅ Entregar Mercancía</button>
            </div>
        `).join('');
    }

    async function entregar(id) {
        if(confirm("¿Ya entregaste los productos al cliente?")) { 
            await fetch(`/api/pedidos/${id}/entregar`, {method:'PUT', headers:{'Authorization':'Bearer '+token}}); 
            abrirPedidos(); 
            checkPedidos(); 
        }
    }

    function logout() { localStorage.removeItem('token'); location.href='/index.html'; }
</script>
</body>
</html>