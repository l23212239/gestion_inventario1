<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Modelorama</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { min-height: 100vh; background: #212529; color: white; }
        .sidebar a { color: #adb5bd; text-decoration: none; padding: 10px 15px; display: block; border-radius: 5px; margin-bottom: 5px; transition: 0.3s; }
        .sidebar a:hover, .sidebar a.active { background: #0d6efd; color: white; }
        .stat-card { transition: transform 0.2s; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-card:hover { transform: translateY(-5px); }
        
        /* Modales */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
        .modal-custom { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; }
    </style>
</head>
<body>

<div class="d-flex">
    <div class="sidebar p-3 d-none d-md-block" style="width: 250px;">
        <h4 class="mb-4 text-center"><i class="bi bi-shop"></i> Modelorama</h4>
        <nav>
            <a href="#" class="active"><i class="bi bi-box-seam"></i> Inventario</a>
            <a href="/ventas.html"><i class="bi bi-cart4"></i> Punto de Venta</a>
            <button onclick="verHistorial()" class="btn btn-outline-secondary w-100 text-start border-0 text-white mt-2"><i class="bi bi-clock-history"></i> Historial</button>
            <hr>
            <div class="mt-auto">
                <small class="text-muted d-block mb-2" id="uName">Usuario</small>
                <button onclick="logout()" class="btn btn-danger btn-sm w-100"><i class="bi bi-box-arrow-left"></i> Salir</button>
            </div>
        </nav>
    </div>

    <div class="container-fluid p-4">
        <div class="d-md-none d-flex justify-content-between mb-3">
            <h3>Modelorama</h3>
            <a href="/ventas.html" class="btn btn-success">Ir a Caja</a>
        </div>

        <div class="row mb-4">
            <div class="col-md-8 mb-3">
                <div class="card stat-card h-100 p-3">
                    <h5 class="card-title text-muted"> Ventas Semanales</h5>
                    <div style="height: 200px;"><canvas id="graficaVentas"></canvas></div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card stat-card h-100 p-3">
                    <h5 class="card-title text-muted"> Top Productos</h5>
                    <div style="height: 200px;"><canvas id="graficaTop"></canvas></div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h2 class="m-0">Inventario</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="abrirModal()"><i class="bi bi-plus-lg"></i> Nuevo</button>
                <button class="btn btn-success" onclick="document.getElementById('inputExcel').click()"><i class="bi bi-file-earmark-excel"></i> Importar</button>
                <button class="btn btn-info text-white" onclick="location.href='/api/exportar'"><i class="bi bi-download"></i> Exportar</button>
            </div>
        </div>

        <div class="d-flex gap-2 mb-4">
            <div class="input-group shadow-sm flex-grow-1">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                <input type="text" id="buscador" class="form-control border-start-0" placeholder="Buscar producto..." onkeyup="filtrarTabla()">
            </div>
            <select class="form-select w-auto shadow-sm" onchange="ordenarInventario(this.value)">
                <option value="defecto">Ordenar...</option>
                <option value="stock_menor">Menor Stock</option>
                <option value="stock_mayor">Mayor Stock</option>
                <option value="nombre_asc">A - Z</option>
            </select>
        </div>
        
        <input type="file" id="inputExcel" hidden onchange="subirExcel()">

        <div class="bg-white p-3 rounded shadow-sm table-responsive">
            <table class="table table-hover align-middle" id="tablaProductos">
                <thead class="table-light">
                    <tr>
                        <th>Img</th>
                        <th>Producto</th>
                        <th>Categor铆as</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Ubicaci贸n</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalProducto" class="modal-overlay">
    <div class="modal-custom">
        <h3 id="tituloModal" class="mb-3">Nuevo Producto</h3>
        <form id="formProducto">
            <input type="hidden" id="prodId"> <div class="row g-3">
                <div class="col-12"><label class="form-label">Nombre</label><input type="text" id="nombre" class="form-control" required></div>
                <div class="col-md-6"><label class="form-label">C贸digo Barras</label><input type="text" id="codigo" class="form-control"></div>
                <div class="col-md-6"><label class="form-label">Ubicaci贸n</label><input type="text" id="ubicacion" class="form-control"></div>
                <div class="col-md-6"><label class="form-label">$ Compra</label><input type="number" id="precioCompra" class="form-control" step="0.5"></div>
                <div class="col-md-6"><label class="form-label fw-bold">$ Venta</label><input type="number" id="precioVenta" class="form-control border-success" step="0.5" required></div>
                <div class="col-md-6"><label class="form-label">Stock</label><input type="number" id="stock" class="form-control"></div>
                <div class="col-md-6"><label class="form-label">Imagen</label><input type="file" id="imagenInput" class="form-control" accept="image/*"></div>
                <div class="col-12">
                    <label class="form-label">Categor铆as</label>
                    <div id="listaCategorias" class="border p-2 rounded bg-light text-dark" style="max-height: 100px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr;"></div>
                </div>
            </div>
            <div class="mt-4 text-end">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalHistorial" class="modal-overlay">
    <div class="modal-custom">
        <h3>Historial de Movimientos</h3>
        <div style="max-height: 400px; overflow-y: auto;" class="mt-3">
            <table class="table table-sm"><thead class="table-dark"><tr><th>Fecha</th><th>Usuario</th><th>Acci贸n</th><th>Detalle</th></tr></thead><tbody id="tblHist"></tbody></table>
        </div>
        <div class="text-end mt-3"><button class="btn btn-secondary" onclick="document.getElementById('modalHistorial').style.display='none'">Cerrar</button></div>
    </div>
</div>

<div id="modalDetalle" class="modal-overlay">
    <div class="modal-custom" style="max-width: 400px;">
        <h4>Detalle de Ventas</h4>
        <div id="divDetalle" class="my-3 border rounded p-2" style="max-height: 300px; overflow-y: auto;"></div>
        <div class="text-end"><button class="btn btn-danger btn-sm" onclick="document.getElementById('modalDetalle').style.display='none'">Cerrar</button></div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');

    // Validaci贸n de Rol
    if (!token) window.location.href = '/index.html';
    if (usuario.rol !== 'admin') window.location.href = (usuario.rol === 'empleado') ? '/ventas.html' : '/index.html';

    document.getElementById('uName').textContent = usuario.usuario || 'Admin';

    let productosGlobal = [];
    let chartVentasInstance = null;

    // Inicializar
    cargarInventario();
    cargarGraficas();

    // 1. CARGA DE DATOS
    async function cargarInventario() {
        try {
            const res = await fetch('/api/productos', { headers: { 'Authorization': 'Bearer ' + token } });
            productosGlobal = await res.json();
            dibujarTabla(productosGlobal);
        } catch (e) { console.error(e); }
    }

    function dibujarTabla(lista) {
        const tbody = document.querySelector('#tablaProductos tbody');
        tbody.innerHTML = '';
        
        if (lista.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay productos</td></tr>'; return;
        }

        lista.forEach(prod => {
            const img = prod.imagen ? `/uploads/${prod.imagen}` : 'https://via.placeholder.com/40';
            const cats = prod.categorias_nombres ? 
                prod.categorias_nombres.split(',').map(c => `<span class="badge bg-primary me-1">${c.trim()}</span>`).join('') : '';

            tbody.innerHTML += `
                <tr>
                    <td><img src="${img}" width="40" height="40" class="rounded object-fit-cover" style="border:1px solid #ddd"></td>
                    <td><div class="fw-bold">${prod.nombre}</div><small class="text-muted">${prod.codigo_barras || ''}</small></td>
                    <td>${cats}</td>
                    <td>$${parseFloat(prod.precio_venta).toFixed(2)}</td>
                    <td class="${prod.stock_actual < 5 ? 'text-danger fw-bold' : ''}">${prod.stock_actual}</td>
                    <td>${prod.ubicacion || ''}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="editarProducto(${prod.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmarEliminar(${prod.id}, '${prod.nombre}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    // 2. FORMULARIO Y MODAL
    const modalProd = document.getElementById('modalProducto');
    const formProd = document.getElementById('formProducto');
    let catsCargadas = false;

    async function abrirModal() {
        modalProd.style.display = 'flex';
        document.getElementById('tituloModal').textContent = "Nuevo Producto";
        document.getElementById('prodId').value = ""; 
        formProd.reset();
        if(!catsCargadas) await cargarCats();
    }
    
    function cerrarModal() { modalProd.style.display = 'none'; }

    async function cargarCats() {
        const res = await fetch('/api/categorias', { headers: { 'Authorization': 'Bearer ' + token } });
        const cats = await res.json();
        const div = document.getElementById('listaCategorias');
        div.innerHTML = cats.map(c => `<div><input type="checkbox" name="cats" value="${c.id}" id="c${c.id}"> <label for="c${c.id}">${c.nombre}</label></div>`).join('');
        catsCargadas = true;
    }

    async function editarProducto(id) {
        await abrirModal();
        document.getElementById('tituloModal').textContent = "Editar Producto";
        document.getElementById('prodId').value = id;

        // Fetch producto individual para asegurar datos frescos
        const res = await fetch(`/api/productos/${id}`, { headers: { 'Authorization': 'Bearer ' + token } });
        const p = await res.json();

        document.getElementById('nombre').value = p.nombre;
        document.getElementById('codigo').value = p.codigo_barras || '';
        document.getElementById('ubicacion').value = p.ubicacion || '';
        document.getElementById('precioCompra').value = p.precio_compra;
        document.getElementById('precioVenta').value = p.precio_venta;
        document.getElementById('stock').value = p.stock_actual;

        if (p.categorias_ids) {
            p.categorias_ids.forEach(cid => {
                const ck = document.getElementById(`c${cid}`);
                if (ck) ck.checked = true;
            });
        }
    }

    // 3. GUARDAR (FORMDATA PARA FOTO + TEXTO)
    formProd.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('prodId').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/productos/${id}` : '/api/productos';

        const fd = new FormData();
        fd.append('nombre', document.getElementById('nombre').value);
        fd.append('codigo_barras', document.getElementById('codigo').value);
        fd.append('ubicacion', document.getElementById('ubicacion').value);
        fd.append('precio_compra', document.getElementById('precioCompra').value);
        fd.append('precio_venta', document.getElementById('precioVenta').value);
        fd.append('stock_actual', document.getElementById('stock').value);

        const cats = Array.from(document.querySelectorAll('input[name="cats"]:checked')).map(c => c.value);
        if(cats.length) fd.append('categorias', cats.join(','));

        const file = document.getElementById('imagenInput').files[0];
        if(file) fd.append('imagen', file);

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Authorization': 'Bearer ' + token },
                body: fd
            });

            if (res.ok) {
                cerrarModal();
                cargarInventario();
                alert("Guardado exitosamente");
            } else {
                const err = await res.json();
                alert("Error: " + err.error);
            }
        } catch (e) { alert("Error de conexi贸n"); }
    });

    async function confirmarEliminar(id, nombre) {
        if (confirm(`驴Eliminar ${nombre}?`)) {
            await fetch(`/api/productos/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
            cargarInventario();
        }
    }

    // 4. FILTROS Y EXCEL
    function filtrarTabla() {
        const txt = document.getElementById('buscador').value.toLowerCase();
        const filtrados = productosGlobal.filter(p => p.nombre.toLowerCase().includes(txt) || (p.categorias_nombres && p.categorias_nombres.toLowerCase().includes(txt)));
        dibujarTabla(filtrados);
    }
    
    function ordenarInventario(c) {
        let l = [...productosGlobal];
        if (c === 'stock_menor') l.sort((a,b) => a.stock_actual - b.stock_actual);
        if (c === 'stock_mayor') l.sort((a,b) => b.stock_actual - a.stock_actual);
        if (c === 'nombre_asc') l.sort((a,b) => a.nombre.localeCompare(b.nombre));
        dibujarTabla(l);
    }

    function subirExcel() {
        const f = document.getElementById('inputExcel').files[0];
        if(f) {
            const fd = new FormData(); fd.append('archivoExcel', f);
            fetch('/api/importar', {method:'POST', body:fd}).then(() => { alert('Importado'); cargarInventario(); });
        }
    }

    // 5. GRFICAS (CON RELLENO DE DAS)
    async function cargarGraficas() {
        try {
            // Ventas
            const res = await fetch('/api/reportes/ventas-semanales', { headers: { 'Authorization': 'Bearer ' + token } });
            const raw = await res.json();
            const labels = [], data = [], realDates = [];
            
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const iso = d.toISOString().split('T')[0];
                const found = raw.find(x => x.dia === iso);
                labels.push(`${d.getDate()}/${d.getMonth()+1}`);
                realDates.push(iso);
                data.push(found ? parseFloat(found.total) : 0);
            }

            if(chartVentasInstance) chartVentasInstance.destroy();
            chartVentasInstance = new Chart(document.getElementById('graficaVentas'), {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Ventas ($)', data: data, backgroundColor: '#0d6efd' }] },
                options: { onClick: (e, el) => { if(el.length) verDetalleDia(realDates[el[0].index]); } }
            });

            // Top Prod
            const res2 = await fetch('/api/reportes/productos-top', { headers: { 'Authorization': 'Bearer ' + token } });
            const top = await res2.json();
            new Chart(document.getElementById('graficaTop'), {
                type: 'doughnut',
                data: { labels: top.map(x=>x.nombre), datasets: [{ data: top.map(x=>x.cantidad_total), backgroundColor: ['#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff'] }] }
            });
        } catch(e) { console.error(e); }
    }

    // 6. HISTORIAL Y DETALLE
    async function verHistorial() {
        document.getElementById('modalHistorial').style.display='flex';
        const res = await fetch('/api/historial', { headers: { 'Authorization': 'Bearer ' + token } });
        const h = await res.json();
        document.getElementById('tblHist').innerHTML = h.map(x => `<tr><td>${new Date(x.fecha).toLocaleString()}</td><td>${x.usuario}</td><td>${x.accion}</td><td>${x.detalle}</td></tr>`).join('');
    }

    async function verDetalleDia(fecha) {
        document.getElementById('modalDetalle').style.display='flex';
        const div = document.getElementById('divDetalle');
        div.innerHTML = 'Cargando...';
        const res = await fetch(`/api/reportes/detalle-dia/${fecha}`, { headers: { 'Authorization': 'Bearer ' + token } });
        const rows = await res.json();
        div.innerHTML = rows.length ? rows.map(r => `<div><strong>${r.nombre}</strong>: ${r.c} uds ($${r.t})</div>`).join('') : 'Sin ventas';
    }

    function logout() { localStorage.removeItem('token'); location.href='/index.html'; }
</script>
</body>
</html>